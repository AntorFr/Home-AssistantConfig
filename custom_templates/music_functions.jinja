{% from 'room_functions.jinja' import areas_entities %}

{%- macro media_from_integration_in_areas(areas,integration) -%}
    {{ expand(integration_entities(integration)) 
    | selectattr('domain','eq','media_player')
    | selectattr('state', 'ne', 'unavailable')
    | selectattr('entity_id', 'in', (areas_entities(areas)| from_json))
    | map(attribute="entity_id")
    | list | to_json }}
{%- endmacro -%}

{%- macro sonos_in_areas(areas) -%}
    {{media_from_integration_in_areas(areas,"sonos")}}
{%- endmacro -%}

{%- macro mass_in_areas(areas) -%}
    {{media_from_integration_in_areas(areas,"Music Assistant")}}
{%- endmacro -%}

{%- macro espmedia_in_areas(areas) -%}
    {{media_from_integration_in_areas(areas,"esphome")}}
{%- endmacro -%}

{%- macro media_in_areas(areas) -%}
  {%- if(sonos_in_areas(areas)|from_json|count) > 0  -%}
    {{sonos_in_areas(areas)}}
  {%- elif(espmedia_in_areas(areas)|from_json|count) > 0  -%}  
    {{espmedia_in_areas(areas)}}
  {%- else -%}
    {{[]}}
  {%- endif -%}
{%- endmacro -%}

{%- macro sonos_not_playing_tv(entity_id) -%}
    {{ (
    (expand(entity_id)
        |rejectattr('attributes.source','defined')
        |map(attribute="entity_id")
        |list
    ) 
    +
    (expand(entity_id)
        |selectattr('attributes.source','defined')
        |rejectattr('attributes.source','eq','TV')
        |map(attribute="entity_id")
        |list
    ) 
    ) | to_json}}
{%- endmacro -%}

{%- macro media_player_get_masters(entity_ids) -%}
  {% set ns = namespace(players = []) %}
  {% for player in expand(entity_ids)
    | selectattr('attributes.group_members', 'defined')
    if player.attributes.group_members == []
    or player.attributes.group_members[0] == player.entity_id %}
    {% set ns.players = ns.players + [player.entity_id] %}
  {% endfor %}
  {{ ns.players | to_json }}
{%- endmacro -%}

{%- macro music_mood_room(room) -%}
        {# ── 1. Contexte global ─────────────────────────────────────── #}
        {% set owner = none %}
        {% if is_state('person.sebastien','home') and is_state('person.laurine','home') %}
            {% set owner = 'famille' %}
        {% elif is_state('person.sebastien','home') %}
            {% set owner = 'Sébastien' %}
        {% elif is_state('person.laurine','home') %}
            {% set owner = 'Laurine' %}
        {% endif %}

        {% set night_deadline = today_at(states('input_datetime.' + iif(is_state('binary_sensor.workday_tomorrow','on'),'children_night_time','children_night_time_we'))) %}

        {# ── 2. Tags selon room + moment ────────────────────────────── #}
        {% set ns = namespace(tags={}) %}

        {% if room == 'bureau' %}
            {% set bureau_owner = 'Sébastien' if is_state('person.sebastien','home') else owner %}
            {% if is_state('binary_sensor.workday_sensor','on') and now().hour <= 19 %}
                {% set ns.tags = dict(ns.tags, **{'mood': 'Concentration', 'context': 'Travail', 'owner': bureau_owner, 'not_genre': 'Récit'}) %}
            {% elif now().hour <= 9 %}
                {% set ns.tags = dict(ns.tags, **{'mood': 'Calme', 'owner': bureau_owner, 'not_genre': 'Récit'}) %}
            {% elif now().hour <= 10 %}
                {% set ns.tags = dict(ns.tags, **{'mood': 'chill', 'owner': bureau_owner, 'not_genre': 'Récit'}) %}
            {% elif now() <= night_deadline %}
                {% set ns.tags = dict(ns.tags, **{'mood': 'Energie', 'owner': bureau_owner, 'not_genre': 'Récit'}) %}
            {% else %}
                {% set ns.tags = dict(ns.tags, **{'mood': 'Calme', 'owner': bureau_owner, 'not_genre': 'Récit'}) %}
            {% endif %}

        {% elif room == 'chambre_timothee' %}
            {% set ns.tags = dict(ns.tags, **{'owner': 'Timothée', 'age_group': 'Enfants'}) %}

        {% elif room == 'chambre_emilie' %}
            {% set ns.tags = dict(ns.tags, **{'owner': 'Émilie', 'age_group': 'Enfants'}) %}

        {% else %}
            {% if now().hour <= 9 %}
                {% set ns.tags = dict(ns.tags, **{'mood': 'Calme', 'owner': owner, 'not_genre': 'Récit'}) %}
            {% elif now().hour <= 10 %}
                {% set ns.tags = dict(ns.tags, **{'mood': 'chill', 'owner': owner, 'not_genre': 'Récit'}) %}
            {% elif now() <= night_deadline %}
                {% set ns.tags = dict(ns.tags, **{'mood': 'Energie', 'owner': owner, 'not_genre': 'Récit'}) %}
            {% else %}
            {% endif %}
        

        {% endif %}

        {{ ns.tags | to_json }}
{%- endmacro -%}

{%- macro music_mood_rooms() -%}
    {% from 'room_functions.jinja' import all_area_identifiers %}
    {% set rooms = all_area_identifiers() | from_json | map('area_id') | reject('none') | unique | list %}
        {% set ns = namespace(data={}) %}
        {% for room in rooms %}
            {% if (mass_in_areas(room) | from_json | count) > 0 %}
            {% set ns.data = dict(ns.data, **{room: (music_mood_room(room) | from_json)}) %}
            {% endif %}
        {% endfor %}
        {{ ns.data | to_json }}
{%- endmacro -%}