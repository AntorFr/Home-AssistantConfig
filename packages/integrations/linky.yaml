template:
 - sensor:     
    - unique_id: "teleinfo_energy" # Energy Total + attr HP/HC
      availability: >
        {{ "true" }}
      state: >
        {% set HCHC = states('sensor.linky_index_hc')  | float * 1000  %} 
        {% set HCHP = states('sensor.linky_index_hp')  | float * 1000 %}

        {{ (HCHC + HCHP) }}

      unit_of_measurement: "Wh"
      state_class: "total_increasing"
      device_class: energy
      attributes:
        Index HP: >-
          {{ states('sensor.linky_index_hp') | float * 1000 }}
        Index HC: >-
          {{ states('sensor.linky_index_hc') | float * 1000 }}
    
    - unique_id: "teleinfo_periode_tarifaire"  # Periode Tarifaire
      #availability: >
      #  {{ "true" if(state_attr("sensor.linky","TIC").PTEC is defined) else "false" }}
      state: >
        {%-if(is_state('sensor.linky_priode_tarifaire',['HP','HC']))%}
          {{ states('sensor.linky_priode_tarifaire') }}
        {%- else %}
          {{'HC' if(is_state('schedule.backup_hc_schedule','on')) else 'HP'}}
        {%- endif %}
      attributes:
        source: >
          {%-if(is_state('sensor.linky_priode_tarifaire',['HP','HC']))%}
          linky
          {%- else %}
          backup_hc_schedule
          {%- endif %}       

    - unique_id: "teleinfo_prix_kwh" # Prix 
      state: >
              {% if is_state('sensor.template_teleinfo_periode_tarifaire', 'HC') %}
              0.1312
              {% else %}
              0.1749
              {% endif %}
      device_class: monetary
      unit_of_measurement: â‚¬/kWh

utility_meter:
  daily_energy:
    source: sensor.template_teleinfo_energy_total
    cycle: daily
  hourly_energy:
    source: sensor.template_teleinfo_energy_total
    cycle: hourly
  quarter_hourly_energy:
    source: sensor.template_teleinfo_energy_total
    cycle: quarter-hourly
  yearly_energy:
    source: sensor.template_teleinfo_energy_total
    cycle: yearly

schedule:
  backup_hc_schedule:
    name: "Heure creuse (backup)"
    monday:
      - from: "01:00:00"
        to: "06:00:00"
      - from: "12:40:00"
        to: "15:30:00"
    tuesday:
      - from: "01:00:00"
        to: "06:00:00"
      - from: "12:40:00"
        to: "15:30:00"
    wednesday:
      - from: "01:00:00"
        to: "06:00:00"
      - from: "12:40:00"
        to: "15:30:00"
    thursday:
      - from: "01:00:00"
        to: "06:00:00"
      - from: "12:40:00"
        to: "15:30:00"
    friday:
      - from: "01:00:00"
        to: "06:00:00"
      - from: "12:40:00"
        to: "15:30:00"
    saturday:
      - from: "01:00:00"
        to: "06:00:00"
      - from: "12:40:00"
        to: "15:30:00"
    sunday:
      - from: "01:00:00"
        to: "06:00:00"
      - from: "12:40:00"
        to: "15:30:00"