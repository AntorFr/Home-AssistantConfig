template:
 - sensor:     
    - unique_id: "teleinfo_puissance" # Power
      availability: >
         {{ "true" if(state_attr("sensor.linky","ENERGY").Power is defined) else "false" }}
      state: >
        {%- if(state_attr("sensor.linky","ENERGY").Power is defined) %}
          {{ state_attr("sensor.linky","ENERGY").Power }}
        {%- endif %}
      unit_of_measurement: "W"
      state_class: "measurement"

    - unique_id: "teleinfo_energyhc" #EnergyHC
      availability: >
        {{ "true" if(state_attr("sensor.linky","TIC").HCHC is defined) else "false" }}
      state: >
        {%- if(state_attr("sensor.linky","TIC").HCHC is defined) %}
          {{ state_attr("sensor.linky","TIC").HCHC }}
        {%- endif %}
      unit_of_measurement: "Wh"
      state_class: "total_increasing"

    - unique_id: "teleinfo_energyhp" # EnergyHP
      availability: >
        {{ "true" if(state_attr("sensor.linky","TIC").HCHP is defined) else "false" }}
      state: >
        {%- if(state_attr("sensor.linky","TIC").HCHP is defined) %}
          {{ state_attr("sensor.linky","TIC").HCHP }}
        {%- endif %}
      unit_of_measurement: "Wh"
      state_class: "total_increasing"

    - unique_id: "teleinfo_energy" # Energy Total + attr HP/HC
      availability: >
        {{ "true" if((state_attr("sensor.linky","TIC").HCHC is defined) and (state_attr("sensor.linky","TIC").HCHP is defined)) else "false" }}
      state: >
        {%- if((state_attr("sensor.linky","TIC").HCHC is defined) and (state_attr("sensor.linky","TIC").HCHP is defined)) %}
          {% set HCHC = state_attr("sensor.linky","TIC").HCHC | int %}
          {% set HCHP = state_attr("sensor.linky","TIC").HCHP | int %}

          {{ (HCHC + HCHP) }}
        {%- endif %}
      unit_of_measurement: "Wh"
      state_class: "total_increasing"
      attributes:
        Index HP: >-
          {{ state_attr("sensor.linky","TIC").HCHP }}
        Index HC: >-
          {{ state_attr("sensor.linky","TIC").HCHC }}
    

    - unique_id: "teleinfo_energy_yesterday" # Energy yesterday
      availability: >
        {{ "true" if(state_attr("sensor.linky","ENERGY").Yesterday is defined) else "false" }}
      state: >
        {%- if(state_attr("sensor.linky","ENERGY").Yesterday is defined) %}
          {{ ( state_attr("sensor.linky","ENERGY").Yesterday *1000 ) |int }}
        {%- endif %}
      
      unit_of_measurement: "Wh"

    - unique_id: "teleinfo_energy_total" # Energy total (year)
      availability: >
        {{ "true" if(state_attr("sensor.linky","ENERGY").Total is defined)  else "false" }}
      state: >
        {%- if(state_attr("sensor.linky","ENERGY").Total is defined) %}
          {{ ( state_attr("sensor.linky","ENERGY").Total *1000 ) |int }}
        {%- endif %}
      unit_of_measurement: "Wh"
      state_class: "total_increasing"

    - unique_id: "teleinfo_periode_tarifaire"  # Periode Tarifaire
      #availability: >
      #  {{ "true" if(state_attr("sensor.linky","TIC").PTEC is defined) else "false" }}
      state: >
        {%-if(state_attr("sensor.linky","TIC").PTEC is defined)%}
          {{ (state_attr("sensor.linky","TIC").PTEC) |replace("..","") }}
        {%- else %}
          {{'HC' if(is_state('schedule.backup_hc_schedule','on')) else 'HP'}}
        {%- endif %}
    - unique_id: "teleinfo_prix_kwh" # Prix 
      state: >
              {% if is_state('sensor.template_teleinfo_periode_tarifaire', 'HC') %}
              0.1312
              {% else %}
              0.1749
              {% endif %}
      device_class: monetary
      unit_of_measurement: â‚¬/kWh

utility_meter:
  daily_energy:
    source: sensor.template_teleinfo_energy_total
    cycle: daily
  hourly_energy:
    source: sensor.template_teleinfo_energy_total
    cycle: hourly
  quarter_hourly_energy:
    source: sensor.template_teleinfo_energy_total
    cycle: quarter-hourly
  yearly_energy:
    source: sensor.template_teleinfo_energy_total
    cycle: yearly

schedule:
  backup_hc_schedule:
    name: "Heure creuse (backup)"
    monday:
      - from: "01:00:00"
        to: "06:00:00"
      - from: "12:40:00"
        to: "15:30:00"
    tuesday:
      - from: "01:00:00"
        to: "06:00:00"
      - from: "12:40:00"
        to: "15:30:00"
    wednesday:
      - from: "01:00:00"
        to: "06:00:00"
      - from: "12:40:00"
        to: "15:30:00"
    thursday:
      - from: "01:00:00"
        to: "06:00:00"
      - from: "12:40:00"
        to: "15:30:00"
    friday:
      - from: "01:00:00"
        to: "06:00:00"
      - from: "12:40:00"
        to: "15:30:00"
    saturday:
      - from: "01:00:00"
        to: "06:00:00"
      - from: "12:40:00"
        to: "15:30:00"
    sunday:
      - from: "01:00:00"
        to: "06:00:00"
      - from: "12:40:00"
        to: "15:30:00"