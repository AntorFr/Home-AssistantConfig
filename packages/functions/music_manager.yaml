sql:
  - name: Music Library
    unique_id: music_library
    db_url: !secret budibase_db 
    query: >
      SELECT
        count(*) as count,
        json_agg(music_inventory) as inventory,
        json_agg(title) as list
      FROM
        music_inventory;
    column: "count"

template:
 - select:
    - name: "Playlist"
      unique_id: playlist
      state: " "
      select_option: []
      options: >
        {{ [" "] + state_attr('sensor.music_library', 'list') }}
      optimistic: true
      icon: mdi:playlist-music
 - sensor:
    - name: "Music mood rooms"
      unique_id: music_mood_rooms
      icon: mdi:music-note-outline
      state: >
        {% from 'music_functions.jinja' import music_mood_rooms %}
        {% set moods_json = music_mood_rooms() | string %}
        {{ moods_json[:240] ~ '|' ~ (moods_json | length) }}
      attributes:
        moods: >
          {% from 'music_functions.jinja' import music_mood_rooms %}
          {{ music_mood_rooms() | from_json}}
        rooms_count: >
          {% from 'music_functions.jinja' import music_mood_rooms %}
          {{ (music_mood_rooms() | from_json | count) }}

rest_command:
  music_library_select:
    url: >-
      https://music-library.berard.me/api/v1/media/select?{{ query_string }}
    method: GET
    content_type: "application/json"
    timeout: 20

intent_script:
###############################################################################
  MusicTurnOn:
    async_action: false
    speech:
      text: >
        {% set zone_text = (' dans ' ~ area) if (area is defined and area|length > 0) else '' %}
        {% set picked = none %}
        {% if action_response is defined and action_response is mapping %}
          {% if action_response.playlist is defined and action_response.playlist|string|trim != '' %}
            {% set picked = action_response.playlist %}
          {% elif action_response.response is defined and action_response.response is mapping and action_response.response.playlist is defined and action_response.response.playlist|string|trim != '' %}
            {% set picked = action_response.response.playlist %}
          {% endif %}
        {% elif response is defined and response is mapping %}
          {% if response.playlist is defined and response.playlist|string|trim != '' %}
            {% set picked = response.playlist %}
          {% elif response.response is defined and response.response is mapping and response.response.playlist is defined and response.response.playlist|string|trim != '' %}
            {% set picked = response.response.playlist %}
          {% endif %}
        {% endif %}
        {% if picked is not none %}
          Ok, j'ai lancé {{ picked }}{{ zone_text }}.
        {% else %}
          Ok, j'ai lancé la musique{{ zone_text }}.
        {% endif %}
    action:
      - alias: "select zone"
        variables:
          zone: >
            {% from 'room_functions.jinja' import area_identifiers %}
            {%-if area is undefined -%}
            RdC
            {%-else -%}
              {%-if area in area_identifiers(["salon","salle_a_manger"]) | from_json -%}
                RdC
              {%-else -%}
                {{area}}
              {%-endif -%}
            {%-endif -%}
      - action: script.play_mood_music
        data:
          areas: "{{zone}}"
          action: play_media
        response_variable: response
      - stop: ""
        response_variable: response
################################################################################
  MusicTurnOff:
    async_action: false
    speech:
      text: "Ok, j'ai arreté la musique {{ ' dans ' if area|length > 0}}{{area}}" #{{response.playlist}} 
    action:
      - alias: "select zone"
        variables:
          zone: >
            {% from 'room_functions.jinja' import area_identifiers %}
            {%-if area is undefined -%}
            RdC
            {%-else -%}
              {%-if area in area_identifiers(["salon","salle_a_manger"]) | from_json -%}
                RdC
              {%-else -%}
                {{area}}
              {%-endif -%}
            {%-endif -%}
      - action: script.play_mood_music
        data:
          areas: "{{zone}}"
          action: media_stop
        response_variable: response
script:  
################################################################################
  play_mood_music:
    alias: "Function - Music manager - Play mood music"
    mode: parallel

    fields:
      areas:
        name: zone de lecture
        required: False
        selector:
          area:
            multiple: true
      action:
        name: action
        required: False
        default: play_media
        selector:
          select:
            options:
              - play_media
              - media_stop
              - play_stop
              - media_play
              - media_pause
              - play_pause
      fallback:
        name: fallback
        required: False
        default: soft
        selector:
          select:
            options:
              - none
              - soft
              - aggressive
      owner:
        name: owner
        required: False
        selector:
          select:
            options: ['Sébastien','Laurine','Timothée','Émilie','enfants','famille']
      mood:
        name: mood
        required: False
        selector:
          select:
            options: ['Calme','Concentration','Energie','Someil','chill','focus']
      context:
        name: context
        required: False
        selector:
          select:
            options: ['Bain','Cuisine','Travail','sport']
      genre:
        name: genre
        required: False
        selector:
          select:
            options: ['Livre','Récit','ambient','classical','electronic','hip-hop','jazz','pop','rock']
      time_of_day:
        name: time_of_day
        required: False
        selector:
          select:
            options: ['Matin','Après-midi','Soirée','Nuit']
      age_group:
        name: age_group
        required: False
        selector:
          select:
            options: ['Adulte','Enfants','Toutes']
      title:
        name: titre
        required: False
        selector:
          text:

    variables:
      zone_ids:
        rdc:
          - 'salon'
          - 'salle_a_manger'
          - 'cuisine'
      # --- normalise optional tag inputs (none if empty) ---
      owner: >
        {% if (owner is not defined) or (owner is none) or (owner|string|trim == '') %}
          {{ none }}
        {% else %}
          {{ owner|string|trim }}
        {% endif %}
      mood: >
        {% if (mood is not defined) or (mood is none) or (mood|string|trim == '') %}
          {{ none }}
        {% else %}
          {{ mood|string|trim }}
        {% endif %}
      context: >
        {% if (context is not defined) or (context is none) or (context|string|trim == '') %}
          {{ none }}
        {% else %}
          {{ context|string|trim }}
        {% endif %}
      genre: >
        {% if (genre is not defined) or (genre is none) or (genre|string|trim == '') %}
          {{ none }}
        {% else %}
          {{ genre|string|trim }}
        {% endif %}
      time_of_day: >
        {% if (time_of_day is not defined) or (time_of_day is none) or (time_of_day|string|trim == '') %}
          {{ none }}
        {% else %}
          {{ time_of_day|string|trim }}
        {% endif %}
      age_group: >
        {% if (age_group is not defined) or (age_group is none) or (age_group|string|trim == '') %}
          {{ none }}
        {% else %}
          {{ age_group|string|trim }}
        {% endif %}
      fallback: >
        {% if (fallback is not defined) or (fallback is none) or (fallback|string|trim == '') %}
          soft
        {% else %}
          {{ fallback|string|trim }}
        {% endif %}
      title: >
        {% if (title is not defined) or (title is none) or (title|string|trim == '') %}
          {{ none }}
        {% else %}
          {{ title|string|trim }}
        {% endif %}

    sequence:
      # ── ÉTAPE 1 : Config de base ──
      - variables:
          areas: >
            {% from 'room_functions.jinja' import all_area_identifiers, area_ids %}
            {%- set ns = namespace(zone=[]) %}
            {% if (areas is none) or (areas == '') %}
              {%- set areas = [] -%}
            {%- elif areas is string -%}
              {%- set areas = [areas] -%}
            {% endif %}
            {%- for room in areas -%}
              {%- if (room | lower) in zone_ids -%}
                {%- set ns.zone = ns.zone + zone_ids[(room | lower)] -%}
              {%- endif -%}
            {%- endfor -%}
            {%- set areas = area_ids(
                              (ns.zone + areas)
                              | unique
                              | select("in", all_area_identifiers() | from_json)
                              | list) -%}
            {{ areas }}
          media_players: >
            {%- from 'music_functions.jinja' import sonos_in_areas, sonos_not_playing_tv, mass_in_areas -%}
            {% set mass_players = mass_in_areas(areas) | from_json %}
            {% if mass_players | count > 0 %}
              {{ mass_players }}
            {% else %}
              {{ sonos_not_playing_tv(sonos_in_areas(areas) | from_json) | from_json }}
            {% endif %}
          media_player_id: "{{ media_players | first }}"
          group_members: "{{ media_players | reject('eq', media_player_id) | list }}"
          resolver_room: "{{ areas | first }}"
          any_playing: >
            {{ (expand(media_players) | selectattr("state", "==", "playing") | list | count) > 0 }}
          action: >
            {%- if ((action is not defined) or (action is none) or (action == '')) -%}
              play_media
            {%- else -%}
              {{ action }}
            {%- endif -%}
          effective_action: >
            {%- if action == 'play_stop' and not any_playing -%}
              play_media
            {%- elif action == 'play_stop' and any_playing -%}
              media_stop
            {%- elif action == 'play_pause' and not any_playing -%}
              media_play
            {%- elif action == 'play_pause' and any_playing -%}
              media_pause
            {%- else -%}
              {{ action }}
            {%- endif -%}

      # ── BRANCHE A : play_media ─────────────────────────────────────
      - alias: "Branche A - play_media"
        if:
          - condition: template
            value_template: "{{ effective_action == 'play_media' }}"
        then:
          # ── A.1 : Déterminer quoi jouer ──
          - variables:
              browser_select_entity: >-
                {% set candidates = states.input_select
                    | selectattr('entity_id', 'search', 'music_browser')
                    | list %}
                {% set ns = namespace(found='') %}
                {% for s in candidates %}
                  {% if area_id(s.entity_id) == resolver_room %}
                    {% set ns.found = s.entity_id %}
                  {% endif %}
                {% endfor %}
                {{ ns.found }}
              browser_selected_title: >-
                {% if browser_select_entity != '' %}
                  {% set val = states(browser_select_entity) | string | trim %}
                  {% if val not in ['', ' ', 'unknown', 'unavailable'] %}
                    {{ val }}
                  {% endif %}
                {% endif %}
              effective_title: >-
                {% if (title is defined) and (title is not none) and (title | string | trim != '') %}
                  {{ title | string | trim }}
                {% elif browser_selected_title | default('') | trim != '' %}
                  {{ browser_selected_title }}
                {% endif %}
              has_explicit_tags: >-
                {{ (owner is not none) or (mood is not none) or (context is not none)
                   or (genre is not none) or (time_of_day is not none) or (age_group is not none) }}
              play_mode: >-
                {% if effective_title | default('') | trim != '' %}
                  by_title
                {% elif has_explicit_tags %}
                  by_tags
                {% else %}
                  by_room_mood
                {% endif %}

          # ── A.2 : Construire la query ──
          - variables:
              selection_tags: >
                {% from 'music_functions.jinja' import music_mood_room %}
                {% if play_mode == 'by_room_mood' %}
                  {{ music_mood_room(resolver_room) | from_json }}
                {% else %}
                  {{ {} }}
                {% endif %}
              query_data: >
                {% if play_mode == 'by_title' %}
                  {{ {'search': effective_title, 'random': 'false', 'limit': '1', 'fallback': fallback} }}
                {% elif play_mode == 'by_tags' %}
                  {% set ns = namespace(q={'random': 'true', 'limit': '1', 'fallback': fallback}) %}
                  {% if owner is not none %}{% set ns.q = dict(ns.q, **{'owner': owner}) %}{% endif %}
                  {% if mood is not none %}{% set ns.q = dict(ns.q, **{'mood': mood}) %}{% endif %}
                  {% if context is not none %}{% set ns.q = dict(ns.q, **{'context': context}) %}{% endif %}
                  {% if genre is not none %}{% set ns.q = dict(ns.q, **{'genre': genre}) %}{% endif %}
                  {% if time_of_day is not none %}{% set ns.q = dict(ns.q, **{'time_of_day': time_of_day}) %}{% endif %}
                  {% if age_group is not none %}{% set ns.q = dict(ns.q, **{'age_group': age_group}) %}{% endif %}
                  {{ ns.q }}
                {% else %}
                  {% set ns = namespace(q={'random': 'true', 'limit': '1'}) %}
                  {% set fb = selection_tags.fallback | default(fallback, true) %}
                  {% if fb is not none %}{% set ns.q = dict(ns.q, **{'fallback': fb}) %}{% endif %}
                  {% for k in ['owner','mood','context','genre','time_of_day','age_group'] %}
                    {% if selection_tags[k] is defined and selection_tags[k] is not none and selection_tags[k] | string | trim != '' %}
                      {% set ns.q = dict(ns.q, **{k: selection_tags[k] | string}) %}
                    {% endif %}
                  {% endfor %}
                  {{ ns.q }}
                {% endif %}
              query_string: "{{ query_data | urlencode }}"

          # ── A.3 : Appel API ──
          - action: rest_command.music_library_select
            data:
              query_string: "{{ query_string }}"
            response_variable: select_response

          - variables:
              selected_candidates: >
                {% set content = none %}
                {% if (select_response is defined)
                    and (select_response.status | int(0) == 200)
                    and (select_response.content is defined) %}
                  {% set content = select_response.content %}
                {% endif %}
                {% if content is mapping %}
                  {{ [content] }}
                {% elif content is string %}
                  {% if content | trim == '' %}
                    {{ [] }}
                  {% else %}
                    {{ content | from_json(default=[]) }}
                  {% endif %}
                {% elif content is iterable %}
                  {{ content }}
                {% else %}
                  {{ [] }}
                {% endif %}
              selected_item: >
                {% if selected_candidates is iterable and (selected_candidates | count > 0) %}
                  {{ selected_candidates | first }}
                {% endif %}

          - if:
              - condition: template
                value_template: "{{ selected_item is not mapping }}"
            then:
              - stop: "Aucun média trouvé"
                error: true

          # ── A.4 : Grouper + lecture ──
          - variables:
              play_media_id: >
                {% if selected_item is mapping and selected_item.source_uri is string %}
                  {% if selected_item.source_uri.startswith('spotify://') %}
                    {{ selected_item.source_uri | replace('spotify://', 'spotify:') | replace('/', ':') }}
                  {% else %}
                    {{ selected_item.source_uri }}
                  {% endif %}
                {% endif %}
              use_mass_service: "{{ media_player_id in integration_entities('Music Assistant') }}"

          - alias: "Grouper si > 1 player"
            if:
              - condition: template
                value_template: "{{ media_players | count > 1 }}"
            then:
              - action: media_player.join
                target:
                  entity_id: "{{ media_player_id }}"
                data:
                  group_members: "{{ group_members }}"

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ use_mass_service }}"
                sequence:
                  - action: music_assistant.play_media
                    target:
                      entity_id: "{{ media_player_id }}"
                    data:
                      media_id: "{{ selected_item.source_uri }}"
                      enqueue: replace
            default:
              - action: media_player.play_media
                target:
                  entity_id: "{{ media_player_id }}"
                data:
                  media_content_id: "{{ play_media_id }}"
                  media_content_type: "{{ selected_item.media_type | default('music') }}"
                  enqueue: replace

          # ── A.5 : Cleanup + notification ──
          - if:
              - condition: template
                value_template: "{{ browser_select_entity | default('') != '' }}"
            then:
              - action: input_select.select_option
                target:
                  entity_id: "{{ browser_select_entity }}"
                data:
                  option: " "

          - variables:
              response:
                playlist: "{{ selected_item.title | default('inconnu') }}"
                player: "{{ expand(media_players) | map(attribute='name') | list }}"
                message: >
                  média {{ selected_item.title | default('inconnu') }} lancé sur {{ expand(media_players) | map(attribute='name') | join(', ') }}
                room: "{{ resolver_room }}"

          - action: script.room_tts_notify
            data:
              room: "{{ response.room }}"
              message: "{{ response.message }}"

          - stop: "Media launched"
            response_variable: response

      # ── BRANCHE B : media_stop ─────────────────────────────────────
      - alias: "Branche B - media_stop"
        if:
          - condition: template
            value_template: "{{ effective_action == 'media_stop' }}"
        then:
          - action: media_player.media_stop
            target:
              entity_id: >
                {%- from 'music_functions.jinja' import media_player_get_masters -%}
                {{ media_player_get_masters(media_players) | from_json }}
          - stop: "Media stopped"

      # ── BRANCHE C : media_play ─────────────────────────────────────
      - alias: "Branche C - media_play"
        if:
          - condition: template
            value_template: "{{ effective_action == 'media_play' }}"
        then:
          - action: media_player.media_play
            target:
              entity_id: >
                {%- from 'music_functions.jinja' import media_player_get_masters -%}
                {{ media_player_get_masters(media_players) | from_json }}
          - stop: "Media resumed"

      # ── BRANCHE D : media_pause ────────────────────────────────────
      - alias: "Branche D - media_pause"
        if:
          - condition: template
            value_template: "{{ effective_action == 'media_pause' }}"
        then:
          - action: media_player.media_pause
            target:
              entity_id: >
                {%- from 'music_functions.jinja' import media_player_get_masters -%}
                {{ media_player_get_masters(media_players) | from_json }}
          - stop: "Media paused"

################################################################################
  chambre_music_douce:
    alias: "Function - Chambres - Musique douce"
    mode: restart
    icon: mdi:playlist-music
    fields:
      child:
        name: enfant
        required: True
        selector:
          select:
            options: ['Timothée','Émilie']
    variables:
      owner: >
        {% if child in ['Timothée','Timothee'] %}
          Timothée
        {% elif child in ['Émilie','Emilie'] %}
          Émilie
        {% endif %}
      room: >
        {% if child in ['Timothée','Timothee'] %}
          chambre_timothee
        {% elif child in ['Émilie','Emilie'] %}
          chambre_emilie
        {% endif %}
    sequence:
      - action: script.play_mood_music
        data:
          areas: "{{ room }}"
          action: play_media
          owner: "{{ owner }}"
          mood: Someil
          fallback: none

automation:
################################################################################
- id: music_browser_refresh_lists
  alias: "Function - Music manager - Refresh music browser lists"
  mode: restart
  trigger:
    - trigger: state
      entity_id: sensor.music_mood_rooms
      attribute: moods
  condition: []
  action:
    - variables:
        all_moods: "{{ state_attr('sensor.music_mood_rooms', 'moods') | default({}, true) }}"
        browser_selects_json: >
          {{
            states.input_select
            | selectattr('entity_id', 'search', 'music_browser')
            | map(attribute='entity_id')
            | list
          }}
    - action: system_log.write
      data:
        level: debug
        message: >
          music_browser_refresh_lists start: {{ browser_selects_json }} select(s)
    - repeat:
        for_each: "{{ browser_selects_json }}"
        sequence:
          - variables:
              select_entity: "{{ repeat.item }}"
              room: "{{ area_id(select_entity) | default(none, true) }}"
              filters: >
                {% if all_moods is mapping and room is not none and (all_moods[room] is defined) %}
                  {{ all_moods[room] }}
                {% else %}
                  {{ {} }}
                {% endif %}
              query_data: >
                {% set ns = namespace(q={'random':'false','limit':'10','fallback':'soft'}) %}
                {% if filters is mapping %}
                  {% for k in ['owner','mood','context','genre','time_of_day','age_group'] %}
                    {% if filters[k] is defined and filters[k] is not none and filters[k]|string|trim != '' %}
                      {% set ns.q = dict(ns.q, **{k: (filters[k]|string)}) %}
                    {% endif %}
                  {% endfor %}
                  {% if filters.fallback is defined and filters.fallback is not none and filters.fallback|string|trim != '' %}
                    {% set ns.q = dict(ns.q, **{'fallback': (filters.fallback|string)}) %}
                  {% endif %}
                {% endif %}
                {{ ns.q }}
              query_string: "{{ query_data | urlencode }}"

          - action: rest_command.music_library_select
            data:
              query_string: "{{ query_string }}"
            response_variable: select_response

          - variables:
              selected_candidates: >
                {% set content = none %}
                {% if (select_response is defined)
                    and (select_response.status | int(0) == 200)
                    and (select_response.content is defined) %}
                  {% set content = select_response.content %}
                {% endif %}

                {% if content is mapping %}
                  {{ [content] }}
                {% elif content is string %}
                  {% if content | trim == '' %}
                    {{ [] }}
                  {% else %}
                    {{ content | from_json(default=[]) }}
                  {% endif %}
                {% elif content is iterable %}
                  {{ content }}
                {% else %}
                  {{ [] }}
                {% endif %}
              titles: >
                {% set ns = namespace(items=[]) %}
                {% for item in selected_candidates %}
                  {% if item is mapping and item.title is defined and item.title|string|trim != '' %}
                    {% set ns.items = ns.items + [item.title|string] %}
                  {% endif %}
                {% endfor %}
                {{ ns.items | unique | sort }}

          - action: system_log.write
            data:
              level: debug
              message: >
                music_browser_refresh_lists item: select={{ select_entity }}, room={{ room }}, titles={{ titles | count }}

          - variables:
              current_value: "{{ states(select_entity) | default(' ', true) }}"

          - action: input_select.set_options
            target:
              entity_id: "{{ select_entity }}"
            data:
              options: "{{ [' '] + titles }}"

          - action: input_select.select_option
            target:
              entity_id: "{{ select_entity }}"
            data:
              option: >-
                {% if current_value in ([' '] + titles) %}
                  {{ current_value }}
                {% else %}
                  {{ ' ' }}
                {% endif %}

################################################################################
- id: handle_tag_scan
  alias: "Function - Music manager - Handle Tag Scan"
  mode: single
  # Hide warnings when triggered while in delay.
  max_exceeded: silent
  variables:
    # Map scanner device ID to media player entity ID
    media_players:
      fa37e0c36e836c9a3fa47145157df38f: media_player.emilie
      7b6a7b292afbcb0ad93f19416ce95b43: media_player.timothee

    playlists: "{{state_attr('input_select.playlist','playlists') |to_json(ensure_ascii=True)}}"
    tags: >
      {%- set ns = namespace(tags=[]) %}
      {%- for tag in (playlists|map(attribute="tags")|list) %}
        {% if (tag|length > 0)%}
          {%- set ns.tags = ns.tags + tag%}
        {% endif %}
      {%endfor%}
      {{ns.tags|unique|list|to_json(ensure_ascii=True)}} 
  trigger:
    trigger: event
    event_type: tag_scanned
  condition:
    # Test that we support this device and tag
    - "{{ trigger.event.data.tag_id in tags }}"
    - "{{ trigger.event.data.device_id in media_players }}"
  action:
    - variables:
        tag: "{{ trigger.event.data.tag_id}}"
        selected_playlist: >
          {%- set ns = namespace(selected_playlists=[]) %}
          {%for playlist in playlists%}
            {% if (tag is not none and tag in playlist.tags)%}
              {%- set ns.selected_playlists = ns.selected_playlists + [playlist] %}
            {% endif %}
          {% endfor  %}
          {{ns.selected_playlists|first|to_json(ensure_ascii=True)}} 

        media_player_entity_id: "{{ media_players[trigger.event.data.device_id] }}"
        media_content_id: "{{ selected_playlist.content_id }}"
        media_content_type: "{{ selected_playlist.content_type }}"
    - action: media_player.play_media
      target:
        entity_id: "{{ media_player_entity_id }}"
      data:
        media_content_id: "{{ media_content_id }}"
        media_content_type: "{{ media_content_type }}"
        enqueue: replace
    - action: media_player.shuffle_set
      data:
        shuffle: true
      target:
        entity_id: "{{ media_player_entity_id }}"
    - delay: 2 # timeout before we allow processing next scan

################################################################################
- id: handle_tag_scan_new
  alias: "Function - Music manager - Handle Tag Scan 2"
  mode: single
  # Hide warnings when triggered while in delay.
  max_exceeded: silent
  variables:
    tags:
      53-EF-D6-D7-60-00-01: "Harry Potter à l'École des Sorciers"
        
  trigger:
    trigger: event
    event_type: tag_scanned
  condition:
    # Test that we support this device and tag
    - "{{ trigger.event.data.tag_id in tags }}"
  action:
    - variables:
        media_player_entity_id: >-
          {% from 'music_functions.jinja' import sonos_in_areas, mass_in_areas  %}
          {{mass_in_areas(area_id(trigger.event.data.device_id))|from_json | first}}
        media_content_id: "{{ tags[trigger.event.data.tag_id] }}"
    - action: music_assistant.play_media
      target:
        entity_id: "{{ media_player_entity_id }}"
      data:
        media_id: "{{ media_content_id }}"
        enqueue: replace
    - delay: 2 # timeout before we allow processing next scan

 ################################################################################          
- id: adapte_volume_salon 
  alias: "Function - Music manager - Adapte volume Salon"
  description: ""
  mode: single
  trigger:
    - trigger: state
      entity_id:
        - media_player.salon
      attribute: source
      to: TV
      id: tv
    - trigger: state
      entity_id:
        - media_player.salon
      attribute: source
      from: TV
      id: music
  condition: []
  action:
    - choose:
        - conditions:
            - condition: trigger
              id: tv
          sequence:
            - action: media_player.volume_set
              data:
                volume_level: 0.16
              target:
                entity_id: media_player.salon
        - conditions:
            - condition: trigger
              id: music
          sequence:
            - action: media_player.volume_set
              data:
                volume_level: 0.08
              target:
                entity_id: media_player.salon
      default: []

################################################################################
input_select:
  playlist:
    name: Playlist
    options:
        - ' '
      ## Famille ##
        - La vie est belle
        - Feel good acoustic
        - Chilled Classical
        - Peaceful Meditation
        - Ambient Relaxation
        - Sleep
      ## Sebastien ##
        - Malukah
        - Fantasy board gaming
        - Reading Adventure
        - Sith Meditation
        - Star Wars (epic)
        - Sea Song
        - Champs Marin
        - Sport Motivation 2024
      ## Laurine ##
        - Sleepy Ghibli
        - Harry Potter
      ## Enfants ##
        - Millie D
        - Noisette
        - Kidico
        - KidStory
        - Dance Émilie
        - Princess disney france
        - Magic system
        - Petit loup
        - Bulle et Bob
        - Histoire Aldebert
        - Il etait une fois
        - Mortel Adele
        - Planete Alpha
        - Lolirock
        - Histoire d’espace
        - Bestiole
    icon: mdi:playlist-music

homeassistant:
  customize:
    input_select.playlist:
      playlists:
      ## Famille ##
        - title: La vie est belle
          content_id: spotify:playlist:37i9dQZF1DXdrln2UyZD7F
          content_type: playlist
          style: ['motivation']
          public: ['Sebastien', 'Laurine', 'Famille']
          tags: []
        - title: Feel good acoustic
          content_id: spotify:playlist:37i9dQZF1DWXRvPx3nttRN
          content_type: playlist
          style: ['chill']
          public: ['Sebastien', 'Laurine', 'Famille']
          tags: []
        - title: Sport Motivation 2024
          content_id: spotify:playlist:6rkZzuLbq5LbbFl3u0nTxf
          content_type: playlist
          style: ['motivation']
          public: ['Sebastien', 'Famille']
          tags: []
        - title: Chilled Classical
          content_id: spotify:playlist:37i9dQZF1DWUvHZA1zLcjW
          content_type: playlist
          style: ['chill']
          public: ['Sebastien', 'Laurine', 'Famille']
          tags: []
        - title: Peaceful Meditation
          content_id: spotify:playlist:37i9dQZF1DWZqd5JICZI0u
          content_type: playlist
          style: ['zen','work']
          public: ['Sebastien', 'Laurine', 'Famille']
          tags: []
        - title: Ambient Relaxation
          content_id: spotify:playlist:37i9dQZF1DX3Ogo9pFvBkY
          content_type: playlist
          style: ['zen','work']
          public: ['Sebastien', 'Laurine', 'Famille']
          tags: []
        - title: Sleep
          content_id: spotify:playlist:37i9dQZF1DWZd79rJ6a7lp
          content_type: playlist
          style: ['zen','work']
          public: ['Sebastien', 'Laurine', 'Famille']
          tags: []
        - title: Malukah
          content_id: spotify:playlist:5ZLgTnEANdMIgkfsX63Ykv
          content_type: playlist
          style: ['chill','motivation']
          public: ['Sebastien']
          tags: []
        - title: Fantasy board gaming
          content_id: spotify:playlist:37i9dQZF1DWVdDMUimLXxx
          content_type: playlist
          style: ['zen','chill','work']
          public: ['Sebastien']
          tags: []
        - title: Reading Adventure
          content_id: spotify:playlist:37i9dQZF1DWUWUfWSLE7dn
          content_type: playlist
          style: ['zen','chill','work']
          public: ['Sebastien']
          tags: []
        - title: Sith Meditation
          content_id: spotify:playlist:0YCerIiq6AF59sE3NlRPLQ
          content_type: playlist
          style: ['chill','work']
          public: ['Sebastien']
          tags: []
        - title: Star Wars (epic)
          content_id: spotify:playlist:4iHfX38Gd6isG7FoizRTPg
          content_type: playlist
          style: ['chill','work']
          public: ['Sebastien']
          tags: []
        - title: Sea Song
          content_id: spotify:playlist:24f4OwL1tOAyqbRjrpWqhH
          content_type: playlist
          style: ['chill','motivation']
          public: ['Sebastien']
          tags: []
        - title: Champs Marin
          content_id: spotify:playlist:0wR5cFFOx16rfxOVHo4Kdg
          content_type: playlist
          style: ['motivation']
          public: ['Emilie']
          tags: ['CE-E7-4D-3D']
      ## Laurine ##
        - title: Sleepy Ghibli
          content_id: spotify:playlist:14TCh5wWTPpF2C3RuRTPX9
          content_type: playlist
          style: ['zen','work']
          public: ['Laurine', 'Famille']
          tags: []
        - title: Harry Potter
          content_id: spotify:playlist:2nI2TA9KrHvlcrZWH5xPbz
          content_type: playlist
          style: ['zen','work']
          public: ['Laurine']
          tags: []
      ## Enfants ##
        - title: Millie D
          content_id: spotify:show:6xZWDWtjxF6dEV9KZZNRTF
          content_type: playlist
          style: ['histoire']
          public: ['Timothee','Emilie']
          tags: ['F7-E3-4D-3D','01-E6-4D-3D']
        - title: Noisette
          content_id: spotify:show:0cfuaJnYvp6iTwXXOFjt0y
          content_type: playlist
          style: ['histoire']
          public: ['Timothee','Emilie']
          tags: ['DF-E7-4D-3D','08-E4-4D-3D']
        - title: Kidico
          content_id: spotify:show:5no3pub2QBaaaeeBdiobLo
          content_type: playlist
          style: ['histoire']
          public: ['Emilie','Timothee']
          tags: ['C0-E6-4D-3D','10-E4-4D-3D']
        - title: KidStory
          content_id: spotify:show:2OApiYYyIQpZ7VTTPLBp7A
          content_type: playlist
          style: ['histoire']
          public: ['Emilie']
          tags: []
        - title: Dance Émilie
          content_id: spotify:playlist:1OdvIJp6A9yvaFsksZANVj
          content_type: playlist
          style: ['motivation']
          public: ['Emilie']
          tags: ['1A-E5-4D-3D']
        - title: Princess disney france
          content_id: spotify:playlist:6YTRixD9kjc4T9oj0SBNXp
          content_type: playlist
          style: ['chill']
          public: ['Emilie']
          tags: ['F8-E5-4D-3D']
        - title: Magic system
          content_id: spotify:playlist:7aUx9jE0vqYsLFAUIZvkkz
          content_type: playlist
          style: ['motivation']
          public: ['Emilie','Timothee']
          tags: ['00-E4-4D-3D']
        - title: Petit loup
          content_id: spotify:album:3b5RlFQSq0ivPNktaRYa9c
          content_type: playlist
          style: ['histoire']
          public: ['Emilie','Timothee']
          tags: ['09-E6-4D-3D']
        - title: Bulle et Bob
          content_id: spotify:playlist:4Gj26yoPs0XKz1DJ5iT01G
          content_type: playlist
          style: ['histoire']
          public: ['Emilie','Timothee']
          tags: ['30-E5-4D-3D','AF-E6-4D-3D']
        - title: Histoire Aldebert
          content_id: spotify:playlist:3IBqtadarJNvU5FXB0VvhZ
          content_type: playlist
          style: ['histoire']
          public: ['Emilie','Timothee']
        - title: Il etait une fois
          content_id: spotify:playlist:00MqrM9DRedq5S8sZbimva
          content_type: playlist
          style: ['histoire']
          public: ['Emilie','Timothee']
          tags: ['04-7F-D7-DA-B4-49-80','04-8A-D7-DA-B4-49-80']
        - title: Mortel Adele
          content_id: spotify:playlist:5HM0G3ehNa5VQnqbyQorvd
          content_type: playlist
          style: ['histoire']
          public: ['Emilie','Timothee']
          tags: ['04-7A-D7-DA-B4-49-80','04-85-D7-DA-B4-49-80']
        - title: Planete Alpha
          content_id: https://editionsrecrealire.com/img/cms/qrcode/CONTE_PLANETE_ALPHA__AUDIO_MP3_OK.mp3
          content_type: music
          style: ['histoire']
          public: ['Emilie','Timothee']
          tags: ['04-70-D7-DA-B4-49-80','04-75-D7-DA-B4-49-80']
        - title: Lolirock
          content_id: spotify:playlist:3SShFGhkyOSbBscaU8T3kX
          content_type: music
          style: ['motivation']
          public: ['Emilie','Timothee']
          tags: ['53-1D-CC-D6-60-00-01','53-22-C7-D6-60-00-01']
        - title: "Histoire d’espace"
          content_id: spotify:playlist:2L19u0cpg3cFqn8SwQM2MQ
          content_type: music
          style: ['histoire']
          public: ['Timothee']
        - title: "Les Bestioles fossiles"
          content_id: spotify:playlist:0OHK3pGkkwIY8WNzZ3op6v
          content_type: music
          style: ['histoire']
          public: ['Emilie','Timothee']