sql:
  - name: Music Library
    unique_id: music_library
    db_url: !secret budibase_db 
    query: >
      SELECT
        count(*) as count,
        json_agg(music_inventory) as inventory,
        json_agg(title) as list
      FROM
        music_inventory;
    column: "count"

template:
 - select:
    - name: "Playlist"
      unique_id: playlist
      state: " "
      select_option: []
      options: >
        {{ [" "] + state_attr('sensor.music_library', 'list') }}
      optimistic: true
      icon: mdi:playlist-music

rest_command:
  music_library_select:
    url: >-
      https://music-library.berard.me/api/v1/media/select?{{ query_string }}
    method: GET
    content_type: "application/json"
    timeout: 20

intent_script:
###############################################################################
  MusicTurnOn:
    async_action: false
    speech:
      text: >
        {% set zone_text = (' dans ' ~ area) if (area is defined and area|length > 0) else '' %}
        {% set picked = none %}
        {% if action_response is defined and action_response is mapping %}
          {% if action_response.playlist is defined and action_response.playlist|string|trim != '' %}
            {% set picked = action_response.playlist %}
          {% elif action_response.response is defined and action_response.response is mapping and action_response.response.playlist is defined and action_response.response.playlist|string|trim != '' %}
            {% set picked = action_response.response.playlist %}
          {% endif %}
        {% elif response is defined and response is mapping %}
          {% if response.playlist is defined and response.playlist|string|trim != '' %}
            {% set picked = response.playlist %}
          {% elif response.response is defined and response.response is mapping and response.response.playlist is defined and response.response.playlist|string|trim != '' %}
            {% set picked = response.response.playlist %}
          {% endif %}
        {% endif %}
        {% if picked is not none %}
          Ok, j'ai lancé {{ picked }}{{ zone_text }}.
        {% else %}
          Ok, j'ai lancé la musique{{ zone_text }}.
        {% endif %}
    action:
      - alias: "select zone"
        variables:
          zone: >
            {% from 'room_functions.jinja' import area_identifiers %}
            {%-if area is undefined -%}
            RdC
            {%-else -%}
              {%-if area in area_identifiers(["salon","salle_a_manger"]) | from_json -%}
                RdC
              {%-else -%}
                {{area}}
              {%-endif -%}
            {%-endif -%}
      - action: script.play_mood_music
        data:
          rooms: "{{zone}}"
          action: play_media
        response_variable: response
      - stop: ""
        response_variable: response
################################################################################
  MusicTurnOff:
    async_action: false
    speech:
      text: "Ok, j'ai arreté la musique {{ ' dans ' if area|length > 0}}{{area}}" #{{response.playlist}} 
    action:
      - alias: "select zone"
        variables:
          zone: >
            {% from 'room_functions.jinja' import area_identifiers %}
            {%-if area is undefined -%}
            RdC
            {%-else -%}
              {%-if area in area_identifiers(["salon","salle_a_manger"]) | from_json -%}
                RdC
              {%-else -%}
                {{area}}
              {%-endif -%}
            {%-endif -%}
      - action: script.play_mood_music
        data:
          rooms: "{{zone}}"
          action: media_stop
        response_variable: response
script:  
################################################################################
  play_mood_music:
    alias: "Function - Music manager - Play mood music"
    mode: parallel

    fields:
      rooms:
        name: zone de lecture
        required: False
        selector:
          area:
            multiple: true
            device:
              - integration: sonos
      action:
        name: action
        required: False
        default: play_media
        selector:
          select:
            options:
              - play_media
              - media_stop
              - play_stop
              - media_play
              - media_pause
              - play_pause
      fallback:
        name: fallback
        required: False
        default: soft
        selector:
          select:
            options:
              - none
              - soft
              - aggressive
      style:
        name: style
        required: False
        selector:
          select:
            options: ['motivation','chill','work','zen','histoire']
      public:
        name: public
        required: False
        selector:
          select:
            options: ['famille','Sébastien','Laurine','Timothée','Émilie','enfants']
      owner:
        name: owner
        required: False
        selector:
          select:
            options: ['Sébastien','Laurine','Timothée','Émilie','enfants','famille']
      mood:
        name: mood
        required: False
        selector:
          select:
            options: ['Calme','Concentration','Energie','Someil','chill','focus','happy']
      context:
        name: context
        required: False
        selector:
          select:
            options: ['Bain','Cuisine','Travail','party','sport']
      genre:
        name: genre
        required: False
        selector:
          select:
            options: ['Livre','ambient','classical','electronic','hip-hop','jazz','pop','rock']
      time_of_day:
        name: time_of_day
        required: False
        selector:
          select:
            options: ['Matin','Après-midi','Soirée','Nuit']
      age_group:
        name: age_group
        required: False
        selector:
          select:
            options: ['Adulte','Enfants','Toutes']
      title:
        name: titre
        required: False
        selector:
          text:

    variables:
      zone_ids:
        rdc:
          - 'salon'
          - 'salle_a_manger'
          - 'cuisine'
      style: >
        {% if (style is not defined) or (style is none) or (style|string|trim == '') %}
          {{ none }}
        {% else %}
          {{ style }}
        {% endif %}
      public: >
        {% if (public is not defined) or (public is none) or (public|string|trim == '') %}
          {{ none }}
        {% else %}
          {{ public }}
        {% endif %}
      owner: >
        {% if (owner is not defined) or (owner is none) or (owner|string|trim == '') %}
          {{ none }}
        {% else %}
          {{ owner }}
        {% endif %}
      mood: >
        {% if (mood is not defined) or (mood is none) or (mood|string|trim == '') %}
          {{ none }}
        {% else %}
          {{ mood }}
        {% endif %}
      context: >
        {% if (context is not defined) or (context is none) or (context|string|trim == '') %}
          {{ none }}
        {% else %}
          {{ context }}
        {% endif %}
      genre: >
        {% if (genre is not defined) or (genre is none) or (genre|string|trim == '') %}
          {{ none }}
        {% else %}
          {{ genre }}
        {% endif %}
      time_of_day: >
        {% if (time_of_day is not defined) or (time_of_day is none) or (time_of_day|string|trim == '') %}
          {{ none }}
        {% else %}
          {{ time_of_day }}
        {% endif %}
      age_group: >
        {% if (age_group is not defined) or (age_group is none) or (age_group|string|trim == '') %}
          {{ none }}
        {% else %}
          {{ age_group }}
        {% endif %}
      fallback: >
        {% if (fallback is not defined) or (fallback is none) or (fallback|string|trim == '') %}
          soft
        {% else %}
          {{ fallback }}
        {% endif %}
      owner_from_public: >
        {{ public }}
      mood_from_style: >
        {% if style == 'motivation' %}
          Energie
        {% elif style == 'chill' %}
          chill
        {% elif style == 'work' %}
          Concentration
        {% elif style == 'zen' %}
          Calme
        {% else %}
          {{ none }}
        {% endif %}
      genre_from_style: >
        {% if style == 'histoire' %}
          Livre
        {% else %}
          {{ none }}
        {% endif %}
      age_group_from_public: >
        {% if public in ['Timothée','Émilie','enfants'] %}
          Enfants
        {% else %}
          {{ none }}
        {% endif %}
      resolved_owner: >
        {% if owner is not none %}
          {{ owner }}
        {% else %}
          {{ owner_from_public }}
        {% endif %}
      resolved_mood: >
        {% if mood is not none %}
          {{ mood }}
        {% else %}
          {{ mood_from_style }}
        {% endif %}
      resolved_genre: >
        {% if genre is not none %}
          {{ genre }}
        {% else %}
          {{ genre_from_style }}
        {% endif %}
      resolved_age_group: >
        {% if age_group is not none %}
          {{ age_group }}
        {% else %}
          {{ age_group_from_public }}
        {% endif %}
      query_data: >
        {% set ns = namespace(q={'random':'true','limit':'1'}) %}
        {% if fallback is not none %}
          {% set ns.q = dict(ns.q, **{'fallback': fallback}) %}
        {% endif %}
        {% if resolved_owner is not none %}
          {% set ns.q = dict(ns.q, **{'owner': resolved_owner}) %}
        {% endif %}
        {% if resolved_mood is not none %}
          {% set ns.q = dict(ns.q, **{'mood': resolved_mood}) %}
        {% endif %}
        {% if context is not none %}
          {% set ns.q = dict(ns.q, **{'context': context}) %}
        {% endif %}
        {% if resolved_genre is not none %}
          {% set ns.q = dict(ns.q, **{'genre': resolved_genre}) %}
        {% endif %}
        {% if time_of_day is not none %}
          {% set ns.q = dict(ns.q, **{'time_of_day': time_of_day}) %}
        {% endif %}
        {% if resolved_age_group is not none %}
          {% set ns.q = dict(ns.q, **{'age_group': resolved_age_group}) %}
        {% endif %}
        {{ ns.q }}
      query_string: "{{ query_data | urlencode }}"

    sequence:
      - if:
          - condition: template
            value_template: >
              {{ (media_player is not defined)
                 or (media_player is none)
                 or (media_player is string and media_player | trim == '')
                 or (media_player is iterable and (media_player | list | count == 0)) }}
        then:
          - variables:
              rooms: >
                {% from 'room_functions.jinja' import all_area_identifiers, area_ids %}

                {%- set ns = namespace(zone=[]) %}

                {% if (rooms is none) or (rooms == '')%}
                  {%- set rooms = [] -%}
                {%- elif rooms is string  -%}
                  {%- set rooms = [rooms] -%}
                {% endif %}

                {%- for room in rooms -%}
                  {%- if (room |lower) in zone_ids -%}
                    {%- set ns.zone = ns.zone + zone_ids[(room |lower)] -%}
                  {%- endif -%}
                {%- endfor -%}

                {%- set rooms =  area_ids(
                                  (ns.zone + rooms)
                                  | unique
                                  | select ("in",all_area_identifiers()|from_json)
                                  |list) -%}

                {{rooms}}
              media_players: >
                {%- from 'music_functions.jinja' import sonos_in_areas, sonos_not_playing_tv, mass_in_areas -%}
                {% set mass_players = mass_in_areas(rooms)|from_json %}
                {% if mass_players|count > 0 %}
                  {{ mass_players }}
                {% else %}
                  {{ sonos_not_playing_tv(sonos_in_areas(rooms)|from_json)|from_json }}
                {% endif %}
              media_player_id: "{{ media_players | first }}"
              group_members: "{{ media_players | reject('eq', media_player_id) | list }}"
              has_manual_title: >
                {{ (title is defined) and (title is not none) and (title|string|trim != '') }}
              time_of_day_tag: >
                {% if now().hour < 6 %}
                  Nuit
                {% elif now().hour < 12 %}
                  Matin
                {% elif now().hour < 18 %}
                  Après-midi
                {% else %}
                  Soirée
                {% endif %}
              case_key: >
                {% if has_manual_title %}
                  manual_title
                {% elif rooms == ['bureau'] and is_state('binary_sensor.workday_sensor','on') and now().hour <= 19 %}
                  bureau_work
                {% elif rooms == ['bureau'] and now().hour <= 9 %}
                  bureau_zen
                {% elif rooms == ['bureau'] and now().hour <= 10 %}
                  bureau_chill
                {% elif rooms == ['bureau'] and now() <= today_at(states('input_datetime.'+iif(is_state('binary_sensor.workday_tomorrow','on'),'children_night_time','children_night_time_we'))) %}
                  bureau_motivation
                {% elif rooms == ['bureau'] %}
                  bureau_zen
                {% elif rooms == ['chambre_timothee'] %}
                  chambre_timothee
                {% elif rooms == ['chambre_emilie'] %}
                  chambre_emilie
                {% elif now().hour <= 9 %}
                  house_zen
                {% elif now().hour <= 10 %}
                  house_chill
                {% elif now() <= today_at(states('input_datetime.'+iif(is_state('binary_sensor.workday_tomorrow','on'),'children_night_time','children_night_time_we'))) %}
                  house_motivation
                {% else %}
                  house_zen
                {% endif %}
              selection_tags: >
                {% set ns = namespace(tags={}) %}

                {% if case_key == 'manual_title' %}
                  {% set ns.tags = {} %}

                {% elif case_key in ['bureau_work','bureau_zen','bureau_chill','bureau_motivation'] %}
                  {% set owner = none %}
                  {% set public = none %}
                  {% if is_state('person.sebastien','home') %}
                    {% set owner = 'Sébastien' %}
                    {% set public = 'Sébastien' %}
                  {% elif is_state('person.laurine','home') %}
                    {% set owner = 'Laurine' %}
                    {% set public = 'Laurine' %}
                  {% endif %}

                  {% if case_key == 'bureau_work' %}
                    {% set ns.tags = dict(style='work', mood='Concentration', context='Travail') %}
                  {% elif case_key == 'bureau_chill' %}
                    {% set ns.tags = dict(style='chill', mood='chill') %}
                  {% elif case_key == 'bureau_motivation' %}
                    {% set ns.tags = dict(style='motivation', mood='Energie') %}
                  {% else %}
                    {% set ns.tags = dict(style='zen', mood='Calme') %}
                  {% endif %}

                  {% if owner is not none %}
                    {% set ns.tags = dict(ns.tags, **{'owner': owner}) %}
                  {% endif %}
                  {% if public is not none %}
                    {% set ns.tags = dict(ns.tags, **{'public': public}) %}
                  {% endif %}

                {% elif case_key == 'chambre_timothee' %}
                  {% set ns.tags = dict(public='Timothée', owner='Timothée', age_group='Enfants') %}

                {% elif case_key == 'chambre_emilie' %}
                  {% set ns.tags = dict(public='Émilie', owner='Émilie', age_group='Enfants') %}

                {% else %}
                  {% set owner = none %}
                  {% set public = none %}
                  {% if (is_state('person.sebastien','home') and is_state('person.laurine','home')) %}
                    {% set owner = 'famille' %}
                    {% set public = 'famille' %}
                  {% elif is_state('person.sebastien','home') %}
                    {% set owner = 'Sébastien' %}
                    {% set public = 'Sébastien' %}
                  {% elif is_state('person.laurine','home') %}
                    {% set owner = 'Laurine' %}
                    {% set public = 'Laurine' %}
                  {% endif %}

                  {% if case_key == 'house_chill' %}
                    {% set ns.tags = dict(style='chill', mood='chill') %}
                  {% elif case_key == 'house_motivation' %}
                    {% set ns.tags = dict(style='motivation', mood='Energie') %}
                  {% else %}
                    {% set ns.tags = dict(style='zen', mood='Calme') %}
                  {% endif %}

                  {% if owner is not none %}
                    {% set ns.tags = dict(ns.tags, **{'owner': owner}) %}
                  {% endif %}
                  {% if public is not none %}
                    {% set ns.tags = dict(ns.tags, **{'public': public}) %}
                  {% endif %}
                {% endif %}

                {% if case_key != 'manual_title' and time_of_day_tag is string %}
                  {% set ns.tags = dict(ns.tags, **{'time_of_day': time_of_day_tag}) %}
                {% endif %}

                {{ ns.tags | to_json | from_json }}
              public: "{{ selection_tags.public | default(none, true) }}"
              style: "{{ selection_tags.style | default(none, true) }}"
              owner: "{{ selection_tags.owner | default(none, true) }}"
              mood: "{{ selection_tags.mood | default(none, true) }}"
              context: "{{ selection_tags.context | default(none, true) }}"
              genre: "{{ selection_tags.genre | default(none, true) }}"
              time_of_day: "{{ selection_tags.time_of_day | default(none, true) }}"
              age_group: "{{ selection_tags.age_group | default(none, true) }}"
              any_playing: >
                {{(expand(media_players) | selectattr("state", "==", "playing") | list | count) > 0}}
              action: >
                {%- if ((action is not defined) or (action is none)  or (action == '')) -%}
                  play_media
                {%- else -%}
                  {{action}}
                {%- endif -%}

          - alias: "play_media"
            if:
            - condition: template
              value_template: >
                 {{action == "play_media"
                    or (action == "play_stop" and not any_playing ) }}
            then:
              - alias: "more than one player, create a groupe"
                if:
                  - condition: template
                    value_template: '{{ media_players | count > 1 }}'
                then:
                  - action: media_player.join
                    target:
                      entity_id: >
                        {{media_player_id}}
                    data:
                      group_members: >
                        {{group_members}}
              - action: script.play_mood_music
                data:
                  media_player: "{{media_player_id}}"
                  style: "{{style}}"
                  public: "{{public}}"
                  owner: "{{owner}}"
                  mood: "{{mood}}"
                  context: "{{context}}"
                  genre: "{{genre}}"
                  time_of_day: "{{time_of_day}}"
                  age_group: "{{age_group}}"
                  fallback: "{{fallback}}"
                  title: "{{title}}"
                response_variable: response
              - stop: "Media launched"
                response_variable: response

          - alias: "stop"
            if:
            - condition: template
              value_template: >
                 {{action == "media_stop" or
                 (action == "play_stop" and any_playing) }}
            then:
              - action: media_player.media_stop
                target:
                  entity_id: >
                    {%- from 'music_functions.jinja' import media_player_get_masters -%}
                    {{media_player_get_masters(media_players)|from_json }}

          - alias: "media_play"
            if:
            - condition: template
              value_template: >
                 {{action == "media_play" or
                 (action == "play_pause" and not any_playing) }}
            then:
              - action: media_player.media_play
                target:
                  entity_id: >
                    {%- from 'music_functions.jinja' import media_player_get_masters -%}
                    {{media_player_get_masters(media_players)|from_json }}

          - alias: "pause"
            if:
            - condition: template
              value_template: >
                 {{action == "media_pause" or
                 (action == "play_pause" and any_playing) }}
            then:
              - action: media_player.media_pause
                target:
                  entity_id: >
                    {%- from 'music_functions.jinja' import media_player_get_masters -%}
                    {{media_player_get_masters(media_players)|from_json }}

          - stop: "Action executed"

      - action: rest_command.music_library_select
        data:
          query_string: "{{ query_string }}"
        response_variable: select_response

      - variables:
          selected_candidates: >
            {% set content = none %}
            {% if (select_response is defined)
                and (select_response.status | int(0) == 200)
                and (select_response.content is defined) %}
              {% set content = select_response.content %}
            {% endif %}

            {% if content is mapping %}
              {{ [content] }}
            {% elif content is string %}
              {% if content | trim == '' %}
                {{ [] }}
              {% else %}
                {{ content | from_json(default=[]) }}
              {% endif %}
            {% elif content is iterable %}
              {{ content }}
            {% else %}
              {{ [] }}
            {% endif %}
          selected_item: >
            {% if selected_candidates is iterable and (selected_candidates|count > 0) %}
              {{ selected_candidates | first }}
            {% endif %}
          media_player_list: >
            {% if media_player is string %}
              {{ [media_player] }}
            {% else %}
              {{ media_player | list }}
            {% endif %}
          first_media_player: "{{ media_player_list | first }}"
          play_media_id: >
            {% if selected_item is mapping and selected_item.source_uri is string %}
              {% if selected_item.source_uri.startswith('spotify://') %}
                {{ selected_item.source_uri | replace('spotify://', 'spotify:') | replace('/', ':') }}
              {% else %}
                {{ selected_item.source_uri }}
              {% endif %}
            {% endif %}
          use_mass_service: "{{ first_media_player in integration_entities('Music Assistant') }}"

      - if:
          - condition: template
            value_template: "{{ selected_item is not mapping }}"
        then:
          - stop: "Aucun média trouvé"
            error: true

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ use_mass_service }}"
            sequence:
              - action: music_assistant.play_media
                target:
                  entity_id: "{{ media_player_list }}"
                data:
                  media_id: "{{ selected_item.source_uri }}"
                  enqueue: replace
        default:
          - action: media_player.play_media
            target:
              entity_id: "{{ media_player_list }}"
            data:
              media_content_id: "{{ play_media_id }}"
              media_content_type: "{{ selected_item.media_type | default('music') }}"
              enqueue: replace

      - variables:
          response:
            playlist: "{{ selected_item.title | default('inconnu') }}"
            player: "{{ expand(media_player_list)|map(attribute='name')| list }}"
            message: >
              média {{ selected_item.title | default('inconnu') }} lancé sur {{expand(media_player_list)|map(attribute="name")|join(', ')}}
            room: "{{ area_id(first_media_player) }}"

      - action: script.room_tts_notify
        data:
          room: "{{response.room}}"
          message: "{{response.message}}"

      - stop: "Media launched"
        response_variable: response

################################################################################
  chambre_music_douce:
    alias: "Function - Chambres - Musique douce"
    mode: restart
    icon: mdi:playlist-music
    fields:
      child:
        name: enfant
        required: True
        selector:
          select:
            options: ['Timothée','Émilie']
    variables:
      owner: >
        {% if child in ['Timothée','Timothee'] %}
          Timothée
        {% elif child in ['Émilie','Emilie'] %}
          Émilie
        {% endif %}
      room: >
        {% if child in ['Timothée','Timothee'] %}
          chambre_timothee
        {% elif child in ['Émilie','Emilie'] %}
          chambre_emilie
        {% endif %}
    sequence:
      - action: script.play_mood_music
        data:
          rooms: "{{ room }}"
          action: play_media
          owner: "{{ owner }}"
          mood: Someil
          fallback: none

automation:
################################################################################
- id: handle_tag_scan
  alias: "Function - Music manager - Handle Tag Scan"
  mode: single
  # Hide warnings when triggered while in delay.
  max_exceeded: silent
  variables:
    # Map scanner device ID to media player entity ID
    media_players:
      fa37e0c36e836c9a3fa47145157df38f: media_player.emilie
      7b6a7b292afbcb0ad93f19416ce95b43: media_player.timothee

    playlists: "{{state_attr('input_select.playlist','playlists') |to_json(ensure_ascii=True)}}"
    tags: >
      {%- set ns = namespace(tags=[]) %}
      {%- for tag in (playlists|map(attribute="tags")|list) %}
        {% if (tag|length > 0)%}
          {%- set ns.tags = ns.tags + tag%}
        {% endif %}
      {%endfor%}
      {{ns.tags|unique|list|to_json(ensure_ascii=True)}} 
  trigger:
    trigger: event
    event_type: tag_scanned
  condition:
    # Test that we support this device and tag
    - "{{ trigger.event.data.tag_id in tags }}"
    - "{{ trigger.event.data.device_id in media_players }}"
  action:
    - variables:
        tag: "{{ trigger.event.data.tag_id}}"
        selected_playlist: >
          {%- set ns = namespace(selected_playlists=[]) %}
          {%for playlist in playlists%}
            {% if (tag is not none and tag in playlist.tags)%}
              {%- set ns.selected_playlists = ns.selected_playlists + [playlist] %}
            {% endif %}
          {% endfor  %}
          {{ns.selected_playlists|first|to_json(ensure_ascii=True)}} 

        media_player_entity_id: "{{ media_players[trigger.event.data.device_id] }}"
        media_content_id: "{{ selected_playlist.content_id }}"
        media_content_type: "{{ selected_playlist.content_type }}"
    - action: media_player.play_media
      target:
        entity_id: "{{ media_player_entity_id }}"
      data:
        media_content_id: "{{ media_content_id }}"
        media_content_type: "{{ media_content_type }}"
        enqueue: replace
    - action: media_player.shuffle_set
      data:
        shuffle: true
      target:
        entity_id: "{{ media_player_entity_id }}"
    - delay: 2 # timeout before we allow processing next scan

################################################################################
- id: handle_tag_scan_new
  alias: "Function - Music manager - Handle Tag Scan 2"
  mode: single
  # Hide warnings when triggered while in delay.
  max_exceeded: silent
  variables:
    tags:
      53-EF-D6-D7-60-00-01: "Harry Potter à l'École des Sorciers"
        
  trigger:
    trigger: event
    event_type: tag_scanned
  condition:
    # Test that we support this device and tag
    - "{{ trigger.event.data.tag_id in tags }}"
  action:
    - variables:
        media_player_entity_id: >-
          {% from 'music_functions.jinja' import sonos_in_areas, mass_in_areas  %}
          {{mass_in_areas(area_id(trigger.event.data.device_id))|from_json | first}}
        media_content_id: "{{ tags[trigger.event.data.tag_id] }}"
    - action: music_assistant.play_media
      target:
        entity_id: "{{ media_player_entity_id }}"
      data:
        media_id: "{{ media_content_id }}"
        enqueue: replace
    - delay: 2 # timeout before we allow processing next scan

 ################################################################################          
- id: adapte_volume_salon 
  alias: "Function - Music manager - Adapte volume Salon"
  description: ""
  mode: single
  trigger:
    - trigger: state
      entity_id:
        - media_player.salon
      attribute: source
      to: TV
      id: tv
    - trigger: state
      entity_id:
        - media_player.salon
      attribute: source
      from: TV
      id: music
  condition: []
  action:
    - choose:
        - conditions:
            - condition: trigger
              id: tv
          sequence:
            - action: media_player.volume_set
              data:
                volume_level: 0.16
              target:
                entity_id: media_player.salon
        - conditions:
            - condition: trigger
              id: music
          sequence:
            - action: media_player.volume_set
              data:
                volume_level: 0.08
              target:
                entity_id: media_player.salon
      default: []

################################################################################
input_select:
  playlist:
    name: Playlist
    options:
        - ' '
      ## Famille ##
        - La vie est belle
        - Feel good acoustic
        - Chilled Classical
        - Peaceful Meditation
        - Ambient Relaxation
        - Sleep
      ## Sebastien ##
        - Malukah
        - Fantasy board gaming
        - Reading Adventure
        - Sith Meditation
        - Star Wars (epic)
        - Sea Song
        - Champs Marin
        - Sport Motivation 2024
      ## Laurine ##
        - Sleepy Ghibli
        - Harry Potter
      ## Enfants ##
        - Millie D
        - Noisette
        - Kidico
        - KidStory
        - Dance Émilie
        - Princess disney france
        - Magic system
        - Petit loup
        - Bulle et Bob
        - Histoire Aldebert
        - Il etait une fois
        - Mortel Adele
        - Planete Alpha
        - Lolirock
        - Histoire d’espace
        - Bestiole
    icon: mdi:playlist-music

homeassistant:
  customize:
    input_select.playlist:
      playlists:
      ## Famille ##
        - title: La vie est belle
          content_id: spotify:playlist:37i9dQZF1DXdrln2UyZD7F
          content_type: playlist
          style: ['motivation']
          public: ['Sebastien', 'Laurine', 'Famille']
          tags: []
        - title: Feel good acoustic
          content_id: spotify:playlist:37i9dQZF1DWXRvPx3nttRN
          content_type: playlist
          style: ['chill']
          public: ['Sebastien', 'Laurine', 'Famille']
          tags: []
        - title: Sport Motivation 2024
          content_id: spotify:playlist:6rkZzuLbq5LbbFl3u0nTxf
          content_type: playlist
          style: ['motivation']
          public: ['Sebastien', 'Famille']
          tags: []
        - title: Chilled Classical
          content_id: spotify:playlist:37i9dQZF1DWUvHZA1zLcjW
          content_type: playlist
          style: ['chill']
          public: ['Sebastien', 'Laurine', 'Famille']
          tags: []
        - title: Peaceful Meditation
          content_id: spotify:playlist:37i9dQZF1DWZqd5JICZI0u
          content_type: playlist
          style: ['zen','work']
          public: ['Sebastien', 'Laurine', 'Famille']
          tags: []
        - title: Ambient Relaxation
          content_id: spotify:playlist:37i9dQZF1DX3Ogo9pFvBkY
          content_type: playlist
          style: ['zen','work']
          public: ['Sebastien', 'Laurine', 'Famille']
          tags: []
        - title: Sleep
          content_id: spotify:playlist:37i9dQZF1DWZd79rJ6a7lp
          content_type: playlist
          style: ['zen','work']
          public: ['Sebastien', 'Laurine', 'Famille']
          tags: []
        - title: Malukah
          content_id: spotify:playlist:5ZLgTnEANdMIgkfsX63Ykv
          content_type: playlist
          style: ['chill','motivation']
          public: ['Sebastien']
          tags: []
        - title: Fantasy board gaming
          content_id: spotify:playlist:37i9dQZF1DWVdDMUimLXxx
          content_type: playlist
          style: ['zen','chill','work']
          public: ['Sebastien']
          tags: []
        - title: Reading Adventure
          content_id: spotify:playlist:37i9dQZF1DWUWUfWSLE7dn
          content_type: playlist
          style: ['zen','chill','work']
          public: ['Sebastien']
          tags: []
        - title: Sith Meditation
          content_id: spotify:playlist:0YCerIiq6AF59sE3NlRPLQ
          content_type: playlist
          style: ['chill','work']
          public: ['Sebastien']
          tags: []
        - title: Star Wars (epic)
          content_id: spotify:playlist:4iHfX38Gd6isG7FoizRTPg
          content_type: playlist
          style: ['chill','work']
          public: ['Sebastien']
          tags: []
        - title: Sea Song
          content_id: spotify:playlist:24f4OwL1tOAyqbRjrpWqhH
          content_type: playlist
          style: ['chill','motivation']
          public: ['Sebastien']
          tags: []
        - title: Champs Marin
          content_id: spotify:playlist:0wR5cFFOx16rfxOVHo4Kdg
          content_type: playlist
          style: ['motivation']
          public: ['Emilie']
          tags: ['CE-E7-4D-3D']
      ## Laurine ##
        - title: Sleepy Ghibli
          content_id: spotify:playlist:14TCh5wWTPpF2C3RuRTPX9
          content_type: playlist
          style: ['zen','work']
          public: ['Laurine', 'Famille']
          tags: []
        - title: Harry Potter
          content_id: spotify:playlist:2nI2TA9KrHvlcrZWH5xPbz
          content_type: playlist
          style: ['zen','work']
          public: ['Laurine']
          tags: []
      ## Enfants ##
        - title: Millie D
          content_id: spotify:show:6xZWDWtjxF6dEV9KZZNRTF
          content_type: playlist
          style: ['histoire']
          public: ['Timothee','Emilie']
          tags: ['F7-E3-4D-3D','01-E6-4D-3D']
        - title: Noisette
          content_id: spotify:show:0cfuaJnYvp6iTwXXOFjt0y
          content_type: playlist
          style: ['histoire']
          public: ['Timothee','Emilie']
          tags: ['DF-E7-4D-3D','08-E4-4D-3D']
        - title: Kidico
          content_id: spotify:show:5no3pub2QBaaaeeBdiobLo
          content_type: playlist
          style: ['histoire']
          public: ['Emilie','Timothee']
          tags: ['C0-E6-4D-3D','10-E4-4D-3D']
        - title: KidStory
          content_id: spotify:show:2OApiYYyIQpZ7VTTPLBp7A
          content_type: playlist
          style: ['histoire']
          public: ['Emilie']
          tags: []
        - title: Dance Émilie
          content_id: spotify:playlist:1OdvIJp6A9yvaFsksZANVj
          content_type: playlist
          style: ['motivation']
          public: ['Emilie']
          tags: ['1A-E5-4D-3D']
        - title: Princess disney france
          content_id: spotify:playlist:6YTRixD9kjc4T9oj0SBNXp
          content_type: playlist
          style: ['chill']
          public: ['Emilie']
          tags: ['F8-E5-4D-3D']
        - title: Magic system
          content_id: spotify:playlist:7aUx9jE0vqYsLFAUIZvkkz
          content_type: playlist
          style: ['motivation']
          public: ['Emilie','Timothee']
          tags: ['00-E4-4D-3D']
        - title: Petit loup
          content_id: spotify:album:3b5RlFQSq0ivPNktaRYa9c
          content_type: playlist
          style: ['histoire']
          public: ['Emilie','Timothee']
          tags: ['09-E6-4D-3D']
        - title: Bulle et Bob
          content_id: spotify:playlist:4Gj26yoPs0XKz1DJ5iT01G
          content_type: playlist
          style: ['histoire']
          public: ['Emilie','Timothee']
          tags: ['30-E5-4D-3D','AF-E6-4D-3D']
        - title: Histoire Aldebert
          content_id: spotify:playlist:3IBqtadarJNvU5FXB0VvhZ
          content_type: playlist
          style: ['histoire']
          public: ['Emilie','Timothee']
        - title: Il etait une fois
          content_id: spotify:playlist:00MqrM9DRedq5S8sZbimva
          content_type: playlist
          style: ['histoire']
          public: ['Emilie','Timothee']
          tags: ['04-7F-D7-DA-B4-49-80','04-8A-D7-DA-B4-49-80']
        - title: Mortel Adele
          content_id: spotify:playlist:5HM0G3ehNa5VQnqbyQorvd
          content_type: playlist
          style: ['histoire']
          public: ['Emilie','Timothee']
          tags: ['04-7A-D7-DA-B4-49-80','04-85-D7-DA-B4-49-80']
        - title: Planete Alpha
          content_id: https://editionsrecrealire.com/img/cms/qrcode/CONTE_PLANETE_ALPHA__AUDIO_MP3_OK.mp3
          content_type: music
          style: ['histoire']
          public: ['Emilie','Timothee']
          tags: ['04-70-D7-DA-B4-49-80','04-75-D7-DA-B4-49-80']
        - title: Lolirock
          content_id: spotify:playlist:3SShFGhkyOSbBscaU8T3kX
          content_type: music
          style: ['motivation']
          public: ['Emilie','Timothee']
          tags: ['53-1D-CC-D6-60-00-01','53-22-C7-D6-60-00-01']
        - title: "Histoire d’espace"
          content_id: spotify:playlist:2L19u0cpg3cFqn8SwQM2MQ
          content_type: music
          style: ['histoire']
          public: ['Timothee']
        - title: "Les Bestioles fossiles"
          content_id: spotify:playlist:0OHK3pGkkwIY8WNzZ3op6v
          content_type: music
          style: ['histoire']
          public: ['Emilie','Timothee']